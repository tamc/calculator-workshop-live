<!DOCTYPE html>
<html>
    <head>
        <title>Wind turbine calcualtor</title>
        <style>
            th {
                text-align: left;
            }
            #layout {
                display: grid;
                grid-gap: 1rem;
                grid-template-columns: fit-content(20rem) auto;
            }
        </style>
    </head>
    <body>
        <h1>Wind turbine calculator</h1>
        <div id='layout'>
            <div>
                <h2>Inputs</h2>
                <table id='input_table'>
                    <tr>
                        <th>Capacity</th>
                        <td><input type='number' id='input_capacity'></td>
                        <td>MW</td>
                    </tr>
                    <tr>
                        <th>Load factor</th>
                        <td><input type='number' id='input_load_factor'></td>
                        <td>%</td>
                    </tr>
                </table>
            </div>

            <div>
                <h2>Outputs</h2>
                <table id='output_table'>
                    <tr>
                        <th>Energy</th>
                        <td id='output_energy'>Not known</td>
                    </tr>
                    <tr>
                        <th>Revenue</th>
                        <td id='output_revenue'>Not known</td>
                    </tr>
                </table>
            </div>
        </div>

        <script>
            const input_table = document.querySelector('#input_table');
            const input_capacity = document.querySelector('#input_capacity');
            const input_load_factor = document.querySelector('#input_load_factor');
            const output_energy = document.querySelector('#output_energy');
            const output_revenue = document.querySelector('#output_revenue');

            async function loadData() {
                let url = `/data?${parameters()}`;
                let response = await fetch(url);
                let data = await response.json();
                return data;
            }

            function parameters() {
                let p = new URLSearchParams();
                if(input_capacity.value) {
                    p.set('input_capacity', input_capacity.value);
                }
                if(input_load_factor.value) {
                    p.set('input_load_factor', input_load_factor.value/100);
                }
                return p;
            }
            
            function setControlsToMatchData(data) {
                input_capacity.value = data.input_capacity;
                input_load_factor.value = (+data.input_load_factor * 100).toFixed(0);
            }

            function updateOutputs(data) {
                output_energy.textContent = `${data.output_energy.toFixed(0)} MWh/year`;
                output_revenue.textContent = `Â£${data.output_revenue.toFixed(0)}/year`;
            }

            async function loadInitialValues() {
                let data = await loadData();
                setControlsToMatchData(data);
                updateOutputs(data);
            }

            async function inputChanged() {
                let data = await loadData();
                updateOutputs(data);
            }

            function listenForEvents() {
                input_table.addEventListener('change', inputChanged)
            }

            (async function() {
                await loadInitialValues();
                listenForEvents();
            })()

        </script>
    </body>
</html>